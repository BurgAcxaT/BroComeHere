<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sensor Game Hub</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #3d5afe; --bg: #0a0a0a; --card: #161616; --win: #4caf50; --lose: #f44336; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #eee; margin: 0; padding: 15px; overflow-x: hidden; }
        .screen { display: none; flex-direction: column; align-items: center; min-height: 90vh; }
        .active { display: flex; }
        .card { background: var(--card); border: 1px solid #333; border-radius: 15px; padding: 20px; width: 90%; max-width: 400px; margin: 10px 0; text-align: center; }
        button { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-weight: bold; font-size: 1em; cursor: pointer; margin: 5px 0; }
        button:disabled { background: #444; }
        input { background: #000; border: 1px solid #444; color: white; padding: 15px; border-radius: 10px; width: 80%; text-align: center; font-size: 1.2em; margin-bottom: 10px; }
        
        /* –¶–≤–µ—Ç–∞ */
        #video { width: 100%; border-radius: 10px; transform: scaleX(-1); }
        .aim { width: 20px; height: 20px; border: 2px solid white; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        
        /* –®–∞—Ä–∏–∫ */
        #balloon { background: #ff4081; border-radius: 50%; transition: width 0.1s, height 0.1s; margin: 20px auto; }
        
        /* –°—Ç–∞—Ç—É—Å */
        #status-msg { font-size: 1.5em; font-weight: bold; margin: 20px 0; }
    </style>
</head>
<body>

<div id="screen-lobby" class="screen active">
    <h2>GAME HUB ‚öîÔ∏è</h2>
    
    <div class="card" id="create-section">
        <button onclick="showMyID()">–°–û–ó–î–ê–¢–¨ –ö–û–ú–ù–ê–¢–£ (–Ø –•–û–°–¢)</button>
        <div id="id-area" style="display:none; margin-top:15px;">
            <div style="font-size: 0.8em; color: #888;">–î–ò–ö–¢–£–ô –≠–¢–û–¢ ID –î–†–£–ì–£:</div>
            <div id="my-id" style="font-size: 2em; color: var(--primary); font-family: monospace; font-weight: bold;">...</div>
            <p style="font-size: 0.7em; color: #666;">–ñ–¥–µ–º, –ø–æ–∫–∞ –¥—Ä—É–≥ –≤–≤–µ–¥–µ—Ç —ç—Ç–æ—Ç –∫–æ–¥...</p>
        </div>
    </div>

    <div style="margin: 10px; font-weight: bold; color: #555;">–ò–õ–ò</div>

    <div class="card">
        <input type="text" id="friend-id" placeholder="–í–í–ï–î–ò ID –•–û–°–¢–ê">
        <button style="background: #444;" onclick="connectToFriend()">–í–û–ô–¢–ò –í –ö–û–ú–ù–ê–¢–£</button>
    </div>

    <div id="host-controls" class="card" style="display:none; border-color: var(--primary);">
        <h3 style="color: var(--primary); margin-top: 0;">–í–´–ë–ï–†–ò –ò–ì–†–£:</h3>
        <button onclick="sendGameSelect('color')">1. –¶–í–ï–¢–û–í–ê–Ø –î–£–≠–õ–¨</button>
        <button onclick="sendGameSelect('steady')">2. –ê–ö–ö–£–†–ê–¢–ù–´–ô –ü–û–î–™–ï–ú</button>
        <button onclick="sendGameSelect('balloon')">3. –ù–ê–î–£–ô –®–ê–†–ò–ö</button>
    </div>
</div>

    <div id="screen-color" class="screen">
        <div id="color-target" style="padding: 20px; border-radius: 10px; margin-bottom: 10px; width: 100%;">–ò–©–ò –¶–í–ï–¢!</div>
        <div style="position: relative; width: 100%;">
            <video id="video" autoplay playsinline></video>
            <div class="aim"></div>
        </div>
    </div>

    <div id="screen-steady" class="screen">
        <h3>–ê–ö–ö–£–†–ê–¢–ù–´–ô –ü–û–î–™–ï–ú</h3>
        <p id="steady-instr">–ñ–¥–∏ —Å–∏–≥–Ω–∞–ª–∞...</p>
        <div id="steady-visual" style="font-size: 4em;">üßò</div>
    </div>

    <div id="screen-balloon" class="screen">
        <h3>–ù–ê–î–£–ô –®–ê–†–ò–ö</h3>
        <p>–î—É–π –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω!</p>
        <div id="balloon" style="width: 50px; height: 50px;"></div>
    </div>

    <div id="screen-result" class="screen">
        <h1 id="result-title"></h1>
        <button onclick="location.reload()">–í –ú–ï–ù–Æ</button>
    </div>

    <canvas id="c" style="display:none;"></canvas>

    <script>

function showMyID() {
    document.getElementById('id-area').style.display = 'block';
    // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∑–∞—Ä–∞–Ω–µ–µ
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(s => s.getTracks().forEach(t => t.stop()));
}
        let peer = new Peer();
        let conn = null;
        let isHost = false;
        let sensorActive = false;
        
        // PeerJS Setup
        peer.on('open', id => document.getElementById('my-id').innerText = id);
        peer.on('connection', c => {
            conn = c;
            isHost = true;
            document.getElementById('host-controls').style.display = 'block';
            setupConnection();
        });

        function connectToFriend() {
            const fId = document.getElementById('friend-id').value;
            conn = peer.connect(fId);
            setupConnection();
        }

        function setupConnection() {
            conn.on('data', data => {
                if (data.type === 'GAME_SELECT') showGame(data.game, data.config);
                if (data.type === 'WIN') showFinish('LOSE');
            });
        }

        function sendGameSelect(game) {
            let config = {};
            if (game === 'color') config.color = [Math.random()*255, Math.random()*255, Math.random()*255];
            conn.send({ type: 'GAME_SELECT', game, config });
            showGame(game, config);
        }

        // –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –≠–ö–†–ê–ù–û–í
        function showGame(game, config) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + game).classList.add('active');
            if (game === 'color') startColorGame(config.color);
            if (game === 'steady') startSteadyGame();
            if (game === 'balloon') startBalloonGame();
        }

        // --- –ò–ì–†–ê 1: –¶–í–ï–¢–ê ---
        async function startColorGame(target) {
            const v = document.getElementById('video');
            const targetEl = document.getElementById('color-target');
            targetEl.style.backgroundColor = `rgb(${target[0]}, ${target[1]}, ${target[2]})`;
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            v.srcObject = stream;
            
            const canvas = document.getElementById('c');
            const ctx = canvas.getContext('2d');
            const interval = setInterval(() => {
                canvas.width = v.videoWidth/8; canvas.height = v.videoHeight/8;
                ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
                const p = ctx.getImageData(canvas.width/2, canvas.height/2, 1, 1).data;
                const diff = Math.abs(p[0]-target[0]) + Math.abs(p[1]-target[1]) + Math.abs(p[2]-target[2]);
                if (diff < 100) {
                    clearInterval(interval);
                    sendWin();
                }
            }, 200);
        }

        // --- –ò–ì–†–ê 2: –ê–ö–ö–£–†–ê–¢–ù–û–°–¢–¨ (1-2 Switch) ---
        function startSteadyGame() {
            let stage = 0; // 0: –∂–¥–µ–º, 1: –ø–æ–¥–Ω–∏–º–∞–µ–º, 2: –ø–æ–≤–æ—Ä–æ—Ç, 3: –æ–ø—É—Å–∫–∞–µ–º
            const instr = document.getElementById('steady-instr');
            const visual = document.getElementById('steady-visual');
            
            setTimeout(() => {
                instr.innerText = "–ü–û–î–ù–ò–ú–ê–ô –ú–ï–î–õ–ï–ù–ù–û!";
                stage = 1;
                navigator.vibrate(200);
            }, 3000);

            window.addEventListener('devicemotion', (e) => {
                if (stage === 0) return;
                const acc = e.accelerationIncludingGravity;
                const totalAcc = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
                
                // –ï—Å–ª–∏ –¥–µ—Ä–Ω—É–ª —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ (> 15 –ø—Ä–∏ –Ω–æ—Ä–º–µ 9.8)
                if (totalAcc > 18) {
                    stage = 0;
                    alert("–°–õ–ò–®–ö–û–ú –†–ï–ó–ö–û!");
                    location.reload();
                }
            });

            window.addEventListener('deviceorientation', (e) => {
                if (stage === 1 && e.beta > 70) { // –ü—Ä–∏–º–µ—Ä–Ω—ã–π —É–≥–æ–ª –ø–æ–¥—ä–µ–º–∞
                    stage = 2;
                    instr.innerText = "–ü–ï–†–ï–í–ï–†–ù–ò –¢–ï–õ–ï–§–û–ù (–≠–ö–†–ê–ù–û–ú –í–ù–ò–ó)";
                    visual.innerText = "üîÑ";
                }
                if (stage === 2 && Math.abs(e.gamma) > 160) {
                    stage = 3;
                    instr.innerText = "–û–ü–£–°–ö–ê–ô –ù–ê –°–¢–û–õ";
                    visual.innerText = "üìâ";
                }
                if (stage === 3 && e.beta < 20) {
                    sendWin();
                }
            });
        }

        // --- –ò–ì–†–ê 3: –®–ê–†–ò–ö ---
        async function startBalloonGame() {
            const b = document.getElementById('balloon');
            let size = 50;
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioCtx = new AudioContext();
            const source = audioCtx.createMediaStreamSource(stream);
            const analyser = audioCtx.createAnalyser();
            source.connect(analyser);
            const data = new Uint8Array(analyser.frequencyBinCount);

            function update() {
                analyser.getByteFrequencyData(data);
                const vol = data.reduce((a, b) => a + b) / data.length;
                
                if (vol > 30) {
                    size += vol / 10;
                    // –ï—Å–ª–∏ –¥—É—Ç—å —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ –ø—Ä–∏ –±–æ–ª—å—à–æ–º —Ä–∞–∑–º–µ—Ä–µ - –ª–æ–ø–Ω–µ—Ç
                    if (size > 250 && vol > 60) {
                        alert("–õ–û–ü–ù–£–õ!");
                        location.reload();
                        return;
                    }
                    if (size > 320) {
                        sendWin();
                        return;
                    }
                }
                b.style.width = size + 'px';
                b.style.height = size + 'px';
                requestAnimationFrame(update);
            }
            update();
        }

        // –§–ò–ù–ê–õ
        function sendWin() {
            conn.send('WIN');
            showFinish('WIN');
        }

        function showFinish(res) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screen = document.getElementById('screen-result');
            screen.classList.add('active');
            const title = document.getElementById('result-title');
            if (res === 'WIN') {
                title.innerText = "–¢–´ –ü–û–ë–ï–î–ò–õ! üèÜ";
                document.body.style.background = "var(--win)";
            } else {
                title.innerText = "–ü–†–û–ò–ì–†–´–® üíÄ";
                document.body.style.background = "var(--lose)";
            }
            if(navigator.vibrate) navigator.vibrate(500);
        }
    </script>
</body>
</html>
