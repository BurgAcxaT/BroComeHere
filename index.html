<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Color Battle P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; margin: 0; padding: 20px; transition: 0.3s; }
        .card { background: #1e1e1e; border: 1px solid #333; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .value { font-size: 1.8em; color: #00ff95; font-family: monospace; letter-spacing: 3px; margin: 10px 0; }
        input { background: #000; border: 1px solid #444; color: white; padding: 15px; border-radius: 10px; width: 80%; font-size: 1.1em; text-align: center; margin-bottom: 10px; }
        .btn { background: #3d5afe; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; }
        .btn:active { background: #1a237e; }
        
        #game { display: none; }
        #video { width: 100%; max-width: 400px; border-radius: 15px; border: 3px solid #333; transform: scaleX(-1); }
        #color-target { height: 60px; border-radius: 10px; margin: 15px 0; line-height: 60px; font-weight: bold; font-size: 1.2em; text-shadow: 1px 1px 3px #000; border: 2px solid #fff; }
        .aim { width: 30px; height: 30px; border: 2px solid white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; z-index: 5; pointer-events: none; }
        .v-container { position: relative; display: inline-block; width: 100%; }
        
        .win-bg { background: #2e7d32 !important; }
        .lose-bg { background: #c62828 !important; }
    </style>
</head>
<body>

    <div id="setup">
        <h2>COLOR BATTLE ‚öîÔ∏è</h2>
        
        <div class="card">
            <div style="color: #888; font-size: 0.8em;">–¢–í–û–ô ID (–î–ò–ö–¢–£–ô –î–†–£–ì–£)</div>
            <div id="my-id" class="value">–ó–ê–ì–†–£–ó–ö–ê...</div>
        </div>

        <div class="card">
            <input type="text" id="friend-id" placeholder="–í–í–ï–î–ò ID –î–†–£–ì–ê">
            <button class="btn" onclick="connectToFriend()">–ü–†–ò–°–û–ï–î–ò–ù–ò–¢–¨–°–Ø –ö –î–†–£–ì–£</button>
        </div>
        <p style="color: #666; font-size: 0.9em;">–î–ª—è –∏–≥—Ä—ã –æ–±–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —ç—Ç–æ–º —Å–∞–π—Ç–µ</p>
    </div>

    <div id="game">
        <div id="color-target">–ò–©–ò –¶–í–ï–¢...</div>
        <div class="v-container">
            <video id="video" autoplay playsinline></video>
            <div class="aim"></div>
        </div>
        <div id="status">–°—Ç–∞—Ç—É—Å: –í –ø–æ–∏—Å–∫–µ...</div>
    </div>

    <canvas id="c" style="display:none;"></canvas>

    <script>
        const colors = [
            { name: '–ö–†–ê–°–ù–´–ô', r: 210, g: 40, b: 40 },
            { name: '–ó–ï–õ–ï–ù–´–ô', r: 40, g: 180, b: 40 },
            { name: '–°–ò–ù–ò–ô', r: 40, g: 60, b: 200 },
            { name: '–ñ–ï–õ–¢–´–ô', r: 230, g: 210, b: 20 }
        ];

        let peer = new Peer();
        let conn;
        let targetColor = null;
        let isGameOver = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ID
        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = id;
        });

        // 1. –õ–û–ì–ò–ö–ê –•–û–°–¢–ê (–ñ–¥–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
        peer.on('connection', (c) => {
            conn = c;
            console.log("–î—Ä—É–≥ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!");
            setupEvents();
            
            // –•–æ—Å—Ç –≤—ã–±–∏—Ä–∞–µ—Ç —Ü–≤–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ—Å—Ç—é
            setTimeout(() => {
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                conn.send({ type: 'START', color: randomColor });
                startGame(randomColor);
            }, 1000);
        });

        // 2. –õ–û–ì–ò–ö–ê –ì–û–°–¢–Ø (–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —Å–∞–º–∏)
        function connectToFriend() {
            const fId = document.getElementById('friend-id').value;
            if (!fId) return alert("–í–≤–µ–¥–∏ ID!");
            
            conn = peer.connect(fId);
            conn.on('open', () => {
                console.log("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Ö–æ—Å—Ç—É");
                setupEvents();
            });
        }

        // –û–±—â–∏–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ–±–æ–∏—Ö
        function setupEvents() {
            conn.on('data', (data) => {
                if (data.type === 'START') {
                    startGame(data.color);
                }
                if (data.type === 'WIN') {
                    isGameOver = true;
                    document.body.classList.add('lose-bg');
                    document.getElementById('status').innerText = "–¢–´ –ü–†–û–ò–ì–†–ê–õ! üíÄ";
                    if(navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
                    setTimeout(() => location.reload(), 4000);
                }
            });
        }

        async function startGame(selectedColor) {
            targetColor = selectedColor;
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            
            const targetEl = document.getElementById('color-target');
            targetEl.innerText = `–ë–´–°–¢–†–ï–ï –ù–ê–ô–î–ò: ${targetColor.name}`;
            targetEl.style.backgroundColor = `rgb(${targetColor.r},${targetColor.g},${targetColor.b})`;

            // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video').srcObject = stream;
                checkLoop();
            } catch (e) {
                alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ");
            }
        }

        function checkLoop() {
            const v = document.getElementById('video');
            const canvas = document.getElementById('c');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });

            const interval = setInterval(() => {
                if (isGameOver) return clearInterval(interval);

                canvas.width = v.videoWidth / 8;
                canvas.height = v.videoHeight / 8;
                ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
                
                // –ë–µ—Ä–µ–º –ø–∏–∫—Å–µ–ª—å –∏–∑ —Ü–µ–Ω—Ç—Ä–∞
                const p = ctx.getImageData(canvas.width/2, canvas.height/2, 1, 1).data;
                
                // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–æ–¥—Å—Ç–≤–∞ (—Ä–∞–∑–Ω–∏—Ü–∞ –ø–æ RGB)
                const diff = Math.abs(p[0] - targetColor.r) + Math.abs(p[1] - targetColor.g) + Math.abs(p[2] - targetColor.b);

                if (diff < 100) { // –ü–æ—Ä–æ–≥ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                    isGameOver = true;
                    conn.send({ type: 'WIN' });
                    document.body.classList.add('win-bg');
                    document.getElementById('status').innerText = "–¢–´ –ü–û–ë–ï–î–ò–õ! üèÜ";
                    if(navigator.vibrate) navigator.vibrate(500);
                    setTimeout(() => location.reload(), 4000);
                    clearInterval(interval);
                }
            }, 200);
        }
    </script>
</body>
</html>